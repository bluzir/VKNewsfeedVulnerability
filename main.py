import requests
from time import sleep
from datetime import datetime
token = '727ec5834ed90d17d41590b2b7b680d77c7566a0379359cb01da2fb7a8c66b9bf065498181be5eea7cb9b' # http://vk.cc/2VN6UJ
list_id = None

def create_work_list(target_id): # ета писал хохол
    global list_id
    print('создаем список')
    url = 'https://api.vk.com/method/newsfeed.saveList'
    par = {'title': 'title', 'source_ids': target_id, 'access_token': token}
    request = requests.get(url, params=par)
    request = request.json()
    if 'response' in request:
        list_id = request['response']
    else:
        if 'error' in request and 'error_code' in request['error'] and request['error']['error_code'] == 1170:
            print('у тебя слишком много списков, для работы нужно удалить хотя бы один. сделай это сам')
        else:
            print('неизвестная ошибка')
            print(request)
        exit()
    print ('Список с id:'+str(list_id)+' создан')
    pass

def get_post(x):
    url = 'https://api.vk.com/method/newsfeed.get'
    par = {'access_token': token,
           'count': 1,
           'filters': 'post',
           'v': 5.24,
           'start_from': x,
           'source_ids': 'list'+str(list_id) }
    request = requests.get(url, params = par)
    decode = request.json()
    post = decode['response']
    return post

def get_content(post):
    profiles = post['profiles']
    groups = post['groups']
    content = post['items']
    a = 0
    for item in profiles:
        a += 1
        id = item['id']
        if id != 94598957:
            id = str(id)
            first_name = item['first_name']
            last_name = item['last_name']
            id = ("ID: http://vk.com/id%s") % (id)
            name = ("Имя: %s %s") % (first_name, last_name)
            print (id)
            print (name)
    print ("-------------------------------------")

    for item in groups:
        name = item['name']
        print (("Название:%s") % (name))
    print ("-------------------------------------")

    for item in content:
        source = str(item['source_id'])
        post_id = str(item['post_id'])
        text = item['text']
        date = str(datetime.fromtimestamp(item['date']))
        link = ("Ссылка: http://vk.com/wall%s_%s") % (source, post_id)
        print (link)
        print (date)

    print ("======================================")

def get_next(post):
    next = post['next_from']
    return next

def delete_work_list():
    global list_id
    url = 'https://api.vk.com/method/newsfeed.deleteList'
    par = {'list_id': list_id, 'access_token': token}
    request = requests.get(url, params=par)
    print('список с id '+str(list_id)+' удалено')
    pass

create_work_list('-55450608') # айди паблика
get_content(get_post(1))
count = get_next(get_post(1))
print ("Начинаем парсинг")
i = 0
while i < 100: # кол-во постов
    i += 1
    get_content(get_post(count))
    count = get_next(get_post(count))
    sleep(1)
delete_work_list()
print ("Парсинг окончен")
exit()
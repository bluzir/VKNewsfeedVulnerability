# -*- coding: utf-8 -*-

__author__ = 'Владислав'
import requests
from time import sleep
from datetime import datetime
import sqlite3
conn = sqlite3.connect('publics.db')
c = conn.cursor()

with open("access_token.txt", "r") as myfile:
    token = myfile.read().replace('\n', '')  # http://vk.cc/2VN6UJ

publics = [74575386, 61604817] # список пабликов для парсинга
list_id = None # для списков новостей
count = 10 # сколько постов на паблик будем парсить (лимит 2 недели)


def create_table(pub):  # создаем таблицу с названием = айди паблика
    print ("Создаем таблицу: %s" % (str(pub)))
    c.execute('''CREATE TABLE IF NOT EXISTS '%s'(
          n integer PRIMARY KEY AUTOINCREMENT NOT NULL,
          post_id integer,
          person_id integer,
          link text
          )''' % (str(pub)))
    print ("Таблица создана")


def create_work_list(target_id): # ета писал хохол
    global list_id
    print('создаем список')
    url = 'https://api.vk.com/method/newsfeed.saveList'
    par = {'title': 'title', 'source_ids': target_id, 'access_token': token}
    request = requests.get(url, params=par)
    request = request.json()
    if 'response' in request:
        list_id = request['response']
    else:
        if 'error' in request and 'error_code' in request['error'] and request['error']['error_code'] == 1170:
            print('у тебя слишком много списков, для работы нужно удалить хотя бы один. сделай это сам')
        else:
            print('неизвестная ошибка')
            print(request)
        exit()
    print ('Список с id:'+str(list_id)+' создан')
    pass


def get_post(x): # newsfeed_get для списка новостей
    url = 'https://api.vk.com/method/newsfeed.get'
    par = {'access_token': token,
           'count': 1,
           'filters': 'post',
           'v': 5.24,
           'start_from': x,
           'source_ids': 'list'+str(list_id) }
    request = requests.get(url, params = par)
    decode = request.json()
    post = decode['response']
    return post


def get_ids(post): # получаем список айди для поста
    profiles = post['profiles']
    ids = []
    for item in profiles:
        id = item['id']
        if id != 94598957:
            id = str(id)
            ids.append(id)
    print (ids)
    return ids


def get_link(post): # получаем ссылку на пост
    content = post['items']
    for item in content:
        source = str(item['source_id'])
        post_id = str(item['post_id'])
        text = item['text']
        date = str(datetime.fromtimestamp(item['date']))
        link = ("http://vk.com/wall%s_%s") % (source, post_id)
        print (link)
    return link


def get_id(post):  # так легче читать
    content = post['items']
    for item in content:
        post_id = str(item['post_id'])
    return post_id


def get_next(post):  # получаем параметр next_from для следующего поста
    next = post['next_from']
    return next


def delete_work_list():  # удаляем список новостей после парсинга
    global list_id
    url = 'https://api.vk.com/method/newsfeed.deleteList'
    par = {'list_id': list_id, 'access_token': token}
    request = requests.get(url, params=par)
    print('список с id '+str(list_id)+' удалено')
    pass


def get_result():
    for public_id in publics:
        print ("Начинаем парсинг")
        i = 1
        create_work_list(-public_id)
        create_table(public_id)
        post = get_post(0)
        ids = get_ids(post)
        link = get_link(post)
        for item in ids:
            c.execute("INSERT INTO '%s'(post_id, person_id, link) VALUES  (%s, %s,'%s')" % (public_id, get_id(post), item, link))
        nextpost = get_next(post)
        conn.commit()
        sleep(1)
        while i < count:  # начало нужно для того, чтобы запустить цикл, иначе не получить некст_фром
            i += 1
            post = get_post(nextpost)
            ids = get_ids(post)
            link = get_link(post)
            for item in ids:
                c.execute("INSERT INTO '%s' (post_id, person_id, link) VALUES (%s, %s,'%s')" % (public_id, get_id(post), item, link))
            nextpost = get_next(post)
            conn.commit()
            sleep(1)
        delete_work_list()
    print ("Парсинг окончен")

get_result()
conn.close()
exit()
